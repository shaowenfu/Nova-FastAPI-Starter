<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>WebSocket 通用调试台</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --accent: #10b981;
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #ef4444;
      --warn: #f59e0b;
      --mono: "JetBrains Mono", Consolas, monospace;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 24px;
      background: radial-gradient(circle at 10% 20%, #111827 0, #0b1120 40%, #050816 80%);
      color: var(--text);
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
    }
    h1 { margin: 0 0 4px; font-size: 24px; }
    p.desc { margin: 0; color: var(--muted); }
    .shell { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 16px; }
    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0));
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.25);
    }
    .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    label { display: flex; flex-direction: column; gap: 6px; font-size: 13px; color: var(--muted); }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-size: 14px;
    }
    textarea { min-height: 110px; font-family: var(--mono); }
    button {
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid transparent;
      background: var(--accent);
      color: #0b1224;
      font-weight: 700;
      cursor: pointer;
      transition: transform 120ms ease, filter 120ms ease;
    }
    button.secondary { background: transparent; border-color: var(--border); color: var(--text); }
    button.danger { background: var(--danger); color: #0b1224; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button:hover:not(:disabled) { transform: translateY(-1px); filter: brightness(1.05); }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .row > label { flex: 1; min-width: 180px; }
    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      font-size: 12px;
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--danger); }
    .status-dot.ok { background: var(--accent); }
    .log {
      max-height: 260px;
      overflow-y: auto;
      font-family: var(--mono);
      background: #0b1224;
      border-radius: 8px;
      padding: 12px;
      border: 1px solid var(--border);
    }
    .log-entry { padding: 8px; margin-bottom: 8px; border-radius: 6px; background: rgba(255,255,255,0.03); }
    .log-entry.out { border-left: 3px solid var(--accent); }
    .log-entry.in { border-left: 3px solid #3b82f6; }
    .log-entry.err { border-left: 3px solid var(--danger); }
    .log-entry small { color: var(--muted); display: block; margin-bottom: 4px; }
    pre {
      background: #0b1224;
      border-radius: 8px;
      padding: 12px;
      border: 1px solid var(--border);
      overflow-x: auto;
      font-family: var(--mono);
      color: #d1d5db;
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <h1>WebSocket 通用调试台</h1>
      <p class="desc">支持自定义 Endpoint、子协议、消息类型；兼容 JWT 子协议握手与通用 LLM/echo/ping/status handler。</p>
      <p class="desc"><a href="/static/index.html" style="color: var(--accent); text-decoration:none;">返回静态资源导航</a></p>
    </header>

    <section class="panel">
      <div class="row" style="gap: 16px; align-items: flex-end;">
        <label style="flex: 2;">
          WebSocket Endpoint
          <input id="endpoint" value="ws://localhost:8000/ws/chat" />
        </label>
        <label style="flex: 2;">
          JWT Token（将作为首个 Sec-WebSocket-Protocol 传递）
          <input id="token" placeholder="填写 access token" />
        </label>
        <label style="flex: 1;">
          自定义子协议（可选，排在 token 之后）
          <input id="subprotocol" placeholder="如 chat.v1" />
        </label>
        <div class="pill">
          <span class="status-dot" id="statusDot"></span>
          <span id="statusText">未连接</span>
        </div>
        <div class="row" style="gap: 8px; flex-wrap: nowrap;">
          <button id="connectBtn">连接</button>
          <button id="disconnectBtn" class="secondary" disabled>断开</button>
          <button id="pingBtn" class="secondary" disabled>Ping</button>
        </div>
      </div>
    </section>

    <section class="grid">
      <div class="panel">
        <h3 style="margin-top:0;">消息构造</h3>
        <div class="row">
          <label>
            消息类型
            <select id="msgType">
              <option value="ping">ping</option>
              <option value="status">status</option>
              <option value="echo">echo</option>
              <option value="llm_stream">llm_stream</option>
              <option value="custom">custom...</option>
            </select>
          </label>
          <label>
            自定义类型（当选择 custom 时生效）
            <input id="customType" placeholder="例如 my_event" />
          </label>
        </div>
        <div class="row">
          <label>
            Agent ID（可选，用于区分命名空间）
            <input id="agentId" placeholder="如 general_bot" />
          </label>
          <label style="align-self:flex-end;">
            <span style="display:flex; align-items:center; gap:8px; margin-top:22px;">
              <input type="checkbox" id="includeMemory" />
              <span>llm_stream: include_memory</span>
            </span>
          </label>
        </div>
        <label>
          消息文本（echo / llm_stream 使用）
          <input id="messageText" placeholder="输入要发送的文本内容" />
        </label>
        <label>
          payload JSON（可选，自定义字段会并入请求中的 payload/context）
          <textarea id="payloadJson" placeholder='{"context": {"foo": "bar"}}'></textarea>
        </label>
        <div class="row" style="margin-top:8px;">
          <button id="sendBtn">发送</button>
          <button class="secondary" id="sampleEchoBtn">填充 echo 示例</button>
          <button class="secondary" id="sampleLlmBtn">填充 llm_stream 示例</button>
          <button class="danger" id="clearLogBtn">清空日志</button>
        </div>
      </div>

      <div class="panel">
        <h3 style="margin-top:0;">日志</h3>
        <div id="log" class="log"></div>
      </div>
    </section>

    <section class="panel">
      <h3 style="margin-top:0;">字段说明 / 示例</h3>
      <p class="desc">服务器使用 UnifiedWebSocketRequest。必填字段：type。可选：agent_id、message、payload、context。JWT 通过 Sec-WebSocket-Protocol 首个值传递，后端会回显相同子协议。</p>
      <pre>
Ping:
{
  "type": "ping"
}

Echo:
{
  "type": "echo",
  "message": { "format": "text", "content": "Hello WS" },
  "payload": { "trace_id": "demo-001" }
}

LLM 流式:
{
  "type": "llm_stream",
  "agent_id": "demo-assistant",
  "message": { "format": "text", "content": "帮我总结一下近期任务" },
  "context": { "include_memory": true }
}
      </pre>
    </section>
  </div>

  <script>
    let socket = null;

    const qs = (id) => document.getElementById(id);
    const statusDot = qs("statusDot");
    const statusText = qs("statusText");
    const logBox = qs("log");

    function setStatus(text, ok = false) {
      statusText.textContent = text;
      statusDot.classList.toggle("ok", ok);
    }

    function appendLog(direction, payload, kind = "") {
      const entry = document.createElement("div");
      entry.className = `log-entry ${direction} ${kind}`;
      const ts = new Date().toLocaleTimeString();
      entry.innerHTML = `<small>[${ts}] ${direction === "out" ? "发送" : "接收"}</small><div>${payload}</div>`;
      logBox.prepend(entry);
    }

    function parseJson(text, fallback) {
      if (!text.trim()) return fallback;
      try {
        return JSON.parse(text);
      } catch (e) {
        appendLog("err", `JSON 解析失败: ${e.message}`, "err");
        return fallback;
      }
    }

    function buildMessage() {
      const typeSel = qs("msgType").value;
      const customType = qs("customType").value.trim();
      const type = typeSel === "custom" ? customType || "custom" : typeSel;
      const agentId = qs("agentId").value.trim();
      const messageText = qs("messageText").value.trim();
      const includeMemory = qs("includeMemory").checked;
      const payloadJson = parseJson(qs("payloadJson").value || "{}", {});

      const request = { type };
      if (agentId) request.agent_id = agentId;
      if (messageText) {
        request.message = { format: "text", content: messageText };
      }
      if (payloadJson && Object.keys(payloadJson).length) {
        if (payloadJson.payload || payloadJson.context) {
          request.payload = payloadJson.payload || undefined;
          request.context = payloadJson.context || undefined;
        } else {
          request.payload = payloadJson;
        }
      }
      if (includeMemory) {
        request.context = { ...(request.context || {}), include_memory: true };
      }
      return request;
    }

    function connect() {
      const endpoint = qs("endpoint").value.trim();
      const token = qs("token").value.trim();
      const customProto = qs("subprotocol").value.trim();
      const protocols = [];
      if (token) protocols.push(token);
      if (customProto) protocols.push(customProto);

      try {
        socket = protocols.length ? new WebSocket(endpoint, protocols) : new WebSocket(endpoint);
      } catch (e) {
        appendLog("err", `连接失败: ${e.message}`, "err");
        setStatus("连接失败");
        return;
      }

      socket.onopen = () => {
        setStatus("已连接", true);
        qs("disconnectBtn").disabled = false;
        qs("pingBtn").disabled = false;
        qs("sendBtn").disabled = false;
        appendLog("in", "连接成功");
      };

      socket.onmessage = (event) => appendLog("in", event.data);
      socket.onerror = (event) => appendLog("err", `Error: ${event.message || "连接错误"}`, "err");
      socket.onclose = () => {
        setStatus("未连接");
        qs("disconnectBtn").disabled = true;
        qs("pingBtn").disabled = true;
        qs("sendBtn").disabled = true;
        appendLog("in", "连接已关闭");
      };
    }

    function disconnect() {
      if (socket) socket.close();
      socket = null;
    }

    function sendMessage(msg) {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        appendLog("err", "请先连接 WebSocket", "err");
        return;
      }
      const payload = JSON.stringify(msg);
      socket.send(payload);
      appendLog("out", payload);
    }

    qs("connectBtn").onclick = connect;
    qs("disconnectBtn").onclick = disconnect;
    qs("pingBtn").onclick = () => sendMessage({ type: "ping" });
    qs("sendBtn").onclick = () => sendMessage(buildMessage());
    qs("clearLogBtn").onclick = () => (logBox.innerHTML = "");
    qs("sampleEchoBtn").onclick = () => {
      qs("msgType").value = "echo";
      qs("messageText").value = "Hello from browser";
      qs("payloadJson").value = '{"payload": {"trace_id": "echo-demo"}}';
    };
    qs("sampleLlmBtn").onclick = () => {
      qs("msgType").value = "llm_stream";
      qs("messageText").value = "给我一个本周的开发小贴士";
      qs("includeMemory").checked = false;
      qs("payloadJson").value = '{"context": {"topic": "dev"}}';
    };
  </script>
</body>
</html>
