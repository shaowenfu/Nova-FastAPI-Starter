# Query Normalization 规则填写指南

此文档帮助产品/测试同学在不了解底层实现的情况下，也能安全地编辑 `core/memory_adapter/normalization_map.json`（或 `MEM0_NORMALIZATION_FILE` 指向的文件）。

## 1. 文件结构回顾
```json
{
  "replacements": {
    "AI助手": "陪伴代理A"
  },
  "regex_replacements": [
    {
      "pattern": "\\s+",
      "replacement": " "
    }
  ]
}
```
- `replacements`：最常用的部分，键值对表示“把左侧文本替换成右侧文本”。
- `regex_replacements`：使用正则表达式进行批量替换，适合处理空格、符号等模式化问题。此部分可选。

## 2. 最常用操作：新增字面替换
1. 打开 JSON 文件，在 `replacements` 内新增一行，遵循 `"原词": "要替换成的词"` 格式。
2. 例如发现用户经常说“老李”，希望统一为“李雷”：
   ```json
   "replacements": {
     "老李": "李雷",
     "AI助手": "陪伴代理A"
   }
   ```
3. 注意事项：
   - 需用英文引号、逗号；最后一行不要多加逗号。
   - 值必须是字符串，不能留空。
   - 新增后保存文件并重新启动服务（或热加载），规则即生效。

## 3. 正则替换（可选）
仅在需要统一复杂格式时使用，比如把多个空格压缩为一个：
```json
"regex_replacements": [
  {
    "pattern": "\\s+",
    "replacement": " "
  }
]
```
- `pattern` 写法遵循标准正则语法，特殊字符需要双反斜杠转义（如 `\s` 写成 `\\s`）。
- 如果不熟悉正则，请与研发确认后再添加，避免写错导致替换异常。

## 4. 测试流程建议
1. **记录问题**：当检索结果不理想时，记录原始输入与期望的标准化文案。
2. **更新规则**：依据情况选择字面替换或正则替换。
3. **本地验证**：重启本地或测试环境，运行一次 `normalize_query("原始输入")`（可通过 REPL 或简单脚本）确认输出正确。
4. **回归检查**：在实际对话场景中触发一次，确认记忆检索效果提升。

## 5. 常见问答
- **Q：需要写成英文吗？**  
  A：不需要，完全可以写中文；关键是保持 JSON 格式正确。
- **Q：会不会影响其他文本？**  
  A：替换是全局生效的。如果担心误伤，可以使用更具体的词或结合上下文替换（通过调用 `fetch_memories(..., context={"replacements": {...}})` 控制）。
- **Q：想删除某条规则？**  
  A：直接在 JSON 中删除该行即可，但建议提前和团队确认，以免影响已有逻辑。

如需帮助或评审新的规则，可将修改后的 JSON 片段提交给研发同学一起确认。这样可以逐步积累高质量的映射表，提升记忆检索的命中率。***
